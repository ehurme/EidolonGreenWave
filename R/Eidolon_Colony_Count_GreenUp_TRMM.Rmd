---
title: "Eidolon Colony Count Green Up"
author: "Edward hurme"
date: "10/26/2020"
output: html_document
editor_options: 
  chunk_output_type: inline
---

Here I am investigating the relationship between relative colony size and instantaneous rate of green up.

Green up date is estimated by the MCD12Q2.006 Land Cover Dynamics Yearly Global Model at 500m resolution

# load libraries
```{r setup, echo=FALSE}

# library(groundhog)
# groundhog.day = "2021-05-01"
pkgs <- c('ggplot2', 'dplyr', 'plyr', 'reshape2',
          'tidyverse', 'scales',
          'magrittr', 'data.table',
          'viridisLite','ggpubr','ggpmisc',
       'rnaturalearth', 'rnaturalearthdata', # maps
          'zoo', 'circular', 'CircMLE', 'lubridate', # toolkit
          # models
          'mgcv', 'lme4', 'MuMIn', 'blme',
          # model evaluation
          'performance', 'DHARMa', 'sjPlot')
# groundhog.library(pkgs, groundhog.day, quiet.install = TRUE)
library(pacman)
p_load('ggplot2', 'dplyr', 'plyr', 'reshape2',
          'tidyverse', 'scales',
          'magrittr', 'data.table',
          'viridisLite','ggpubr','ggpmisc',
       'rnaturalearth', 'rnaturalearthdata', # maps
          'zoo', 'circular', 'CircMLE', 'lubridate', # toolkit
          # models
          'mgcv', 'lme4', 'MuMIn', 'blme',
          # model evaluation
          'performance', 'DHARMa', 'sjPlot')

source("../src/IRG_functions.R")
```
# load counts
```{r}
load("../../../../Dropbox/MPI/Eidolon/Greenwave/rdata/colony_count.RData")
```

## summarize
```{r}
colonies$Count[colonies$Location == "Kasanka"] %>% summary

count_sum <- colonies %>% group_by(Country, Location) %>% 
  summarise(start = min(date), end = max(date), 
            duration = round((max(date)-min(date))/365,1),
            interval = median(diff(date)),
    min_max = paste0(round(min(Count, na.rm = TRUE), digits = -2), "-", 
                             round(max(Count, na.rm = TRUE), -2)))
write.csv(count_sum)
```

Acknowledgements
```{r}
# ack <- unique(paste0(colonies$Country, ": ", colonies$Observer))
# ack[order(ack)]
# 
# write.csv(ack, file = )
```

# load GEE data
```{r load GEE data}
EVI <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/rl_MOD13Q1_EVI_2000_2020_ptsB_EidolonColonies_QCOP1_buf50km.csv")
MEVI1 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_Peak_1_2000_2020_ptsB.csv")
MEVI2 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_Peak_2_2000_2020_ptsB.csv")
MIRG1 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_MidGreenup_1_2000_2020_ptsB.csv")
MIRG2 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_MidGreenup_2_2000_2020_ptsB.csv")
MGRD1 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_MidGreendown_1_2000_2020_ptsB.csv")
MGRD2 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_MidGreendown_2_2000_2020_ptsB.csv")
numcycles <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_NumCycles_2000_2020_ptsB.csv")
QA1 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_QA_Overall_1_2000_2020_ptsB.csv")
QA2 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_QA_Overall_2_2000_2020_ptsB.csv")
MEVIamp1 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_EVI_Amplitude_1_2000_2020_ptsB.csv")
MEVIamp2 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_EVI_Amplitude_2_2000_2020_ptsB.csv")
MEVIarea1 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_EVI_Area_1_2000_2020_ptsB.csv")
MEVIarea2 <- read.csv("../../../../Dropbox/GreenWave/EidolonColonies/rawdata/MODIS_Phen_buf67/p_MCD12Q2_EVI_Area_2_2000_2020_ptsB.csv")
```

# water
```{r load GEE data}
precip <- read.csv("../../../../Dropbox/MPI/Eidolon/Greenwave/data/GEE/rm_TRMM_pr_2000_2020_ptsB.csv")
precip$time <- lubridate::ymd_hms(precip$startDate)
```

## join data
```{r join data}
MEVI1$amp <- MEVIamp1$mean
MEVI2$amp <- MEVIamp2$mean
MEVI1$area <- MEVIarea1$mean
MEVI2$area <- MEVIarea2$mean
MEVI1$IRG <- MIRG1$mean
MEVI2$IRG <- MIRG2$mean
MEVI1$GRD <- MGRD1$mean
MEVI2$GRD <- MGRD2$mean
MEVI1$peak <- 1
MEVI2$peak <- 2
MEVI1$QA <- QA1$mean
MEVI2$QA <- QA2$mean

MEVI <- rbind(MEVI1, MEVI2)

MEVI$date_EVI <- ymd("1970-01-01")+MEVI$mean
MEVI$yday_EVI <- yday(MEVI$date_EVI)
MEVI$date_IRG <- ymd("1970-01-01")+MEVI$IRG
MEVI$yday_IRG <- yday(MEVI$date_IRG)
MEVI$date_GRD <- ymd("1970-01-01")+MEVI$GRD
MEVI$yday_GRD <- yday(MEVI$date_GRD)

MEVI <- MEVI[order(MEVI$date_EVI),]
# MEVI$lat <- unique(colonies$Lat)

for(i in 1:nrow(MEVI)){
  MEVI$lat[i] <- unique(colonies$Lat[MEVI$geeID[i] == colonies$geeID])
  MEVI$Location[i] <- unique(colonies$Location[MEVI$geeID[i] == colonies$geeID])
}

EVI$time <- ymd_hms(EVI$startDate)
```

# add IRG to EVI
```{r}
IDs <- 1:17
EVI$IRG <- NA
EVI$Lat <- NA
for(i in 1:length(IDs)){
  idx <- which(EVI$geeID == i)
  e <- EVI[idx,]
  time <- e$time
  evi <- e$mean
  
  spl <- smooth.spline(x = time, y = evi)
  pred <- predict(spl)
  e$pred <- pred$y
  # get derivative of EVI -> IRG
  pred.prime <- predict(spl, deriv=1)
  plot(pred.prime, type = "l")
  # pred.prime$y_scale <- rescale(pred.prime$y, c(0,1))
  # plot(pred.prime$x, pred.prime$y_scale, type = "l")
  EVI$IRG[idx] <- pred.prime$y
  
  EVI$Lat[idx] <- colonies$Lat[which(colonies$geeID == i)[1]]
}
```

# ggplot
```{r}
ggplot(EVI, aes(x = month(time)))+
  geom_smooth(col = 3, aes(y = mean/max(mean), se = FALSE, group = geeID))+
  geom_smooth(aes(y = IRG/max(IRG), group = geeID), se = FALSE, col = 2)+
  geom_smooth(data = reg_colonies, se = FALSE, 
              aes(x = month(month), y = ratio, group = geeID), col = 1)+
  # coord_cartesian(xlim=c(0,12))+
  xlab("ratio")+ylab("month")+theme_classic()+
  facet_wrap(~round(Lat,2), ncol = 6)

```

## Plot colonies on map
```{r , echo=FALSE}
Africa <- ne_countries(continent = "Africa", scale = "medium", returnclass = "sf")
class(Africa)

colonies$year <- year(colonies$date)

batdf_max <- colonies %>% group_by(Country, Location, year) %>% 
  summarise(size = max(ratio, na.rm = TRUE), 
            count = Count[which.max(ratio)],
            Lat = Lat[which.max(ratio)],
            Long = Long[which.max(ratio)],
            date = date[which.max(ratio)])
batdf_max$yday <- yday(batdf_max$date)
batdf_max$month <- month(round_date(batdf_max$date, unit = "month"))

batdf_max_mean <- batdf_max %>% group_by(Country, Location) %>% 
  summarise(size = mean(size),
            peak_size = mean(count),
            Lat = Lat[1],
            Long = Long[1],
            month = round(circ.mean.month(month)),
            yday = round(circ.mean.yday(yday)))

batdf_max_mean$month[which(batdf_max_mean$month == 0)] <- 12

```

## Fig 1
```{r}

options(scipen=10000)
fig1 <- 
  ggplot(data = Africa)+ geom_sf() +
  #coord_sf(xlim = c(-20, 45), ylim = c(-20, 20), expand = FALSE) + 
  xlim(c(-20, 45))+ylim(c(-20, 20))+
  geom_point(data = batdf_max_mean, aes(Long, Lat, size = peak_size, col = month), 
             inherit.aes = FALSE) +
  scale_size_continuous(limits = c(min(batdf_max_mean$peak_size),
                                   max(batdf_max_mean$peak_size)), 
                        breaks = c(6000, 60000, 600000, 6000000),
                        range = c(2, 7))+
  labs(x = 'Longitude', y = 'Latitude')+
  theme_classic() +
  theme(legend.position = "bottom")+
  guides(size = guide_legend(nrow = 2, title = "Avg Peak Size"))+
  viridis::scale_color_viridis(name = "Month", option = "D")
fig1
ggsave(fig1, filename = "../../../../Dropbox/MPI/Eidolon/Greenwave/plots/fig1_avg_colony_map_TRMM.png")
save(batdf_max_mean, file = "../../../../Dropbox/MPI/Eidolon/Greenwave/data/avg_colony_size_TRMM.RData")
```

# calculate entropy
```{r}
EVI$entropy <- NA
EVI$seasonality <- NA
EVI$maxEVImonth <- NA
EVI$EVIannualsum <- NA

EVI$year <- year(EVI$time)
EVI$month <- month(EVI$time)
EVI_monthly <- EVI %>% group_by(geeID, year, month) %>% 
  summarise(EVI = mean(mean, na.rm = TRUE))

for(i in 1:length(IDs)){
  em <- EVI_monthly[EVI_monthly$geeID == IDs[i],]
  # monthly mean
  Rm <- em %>% group_by(month, year) %>% summarise(EVI = mean(EVI, na.rm = TRUE))
  years <- unique(em$year)
  for(j in 1:length(years)){
    R <- mean(Rm$EVI[Rm$year == years[j]], na.rm = TRUE)
  
    # max month
    Rmax <- max(Rm$EVI[Rm$year == years[j]], na.rm = TRUE)
    
    # annual sum
    Ra <- sum(Rm$EVI[Rm$year == years[j]], na.rm = TRUE)
    
    # discrete probability distribution of monthly sum
    ## month/annual
    pm <- Rm$EVI[Rm$year == years[j]]/Ra
  
    # uniform distribution
    qm <- 1/length(Rm$EVI[Rm$year == years[j]])
    
    # relative entropy
    ## quantifies the extent of EVI concentration in the growing season
    D <- sum(pm * log(pm/qm, base = 2), na.rm = TRUE)
    
    # seasonality  
    S <- D * (R/Rmax)
    
    idx <- which(EVI$geeID == IDs[i] & EVI$year == years[j])
    EVI$entropy[idx] <- D
    EVI$seasonality[idx] <- S
    EVI$maxEVImonth[idx] <- Rmax
    EVI$EVIannualsum[idx] <- Ra
  }
}

psych::pairs.panels(EVI[,c("entropy", "seasonality", "maxEVImonth", "EVIannualsum")])
```

# Find corresponding EVI and precipitation data for all colony data
```{r}
IDs <- 1:max(reg_colonies$geeID)
rs <- data.frame()
i = 1
for(i in 1:length(IDs)){
  ID <- i
  
  e <- subset(EVI, EVI$geeID == ID)
  p <- subset(precip, precip$geeID == ID)
    # precip[,c(1,ID+1)]
  # t <- evap[evap$geeID == ID,]
  # names(p) <- c("time", "precip")
  p$precip <- p$mean
  p$time <- ymd_hms(paste0(p$time, " 12:00:00"))
  
  e$time <- ymd_hms(e$startDate)
  c_idx <- which(colonies$geeID == ID)
  colony <- colonies[c_idx,]
  colony$time <- ymd(colony$date)
    
  par(mar = c(1,4,1,1), oma = c(1,1,1,1), xpd=FALSE)
  layout(rbind(1,2))
  
  plot(as.Date(ymd(ymd_hms(e$startDate))), e$mean, type = "l", lwd = 2,
       ylab = "EVI", xlab = "", ylim = c(0, 1), col = 3,
       xlim = c((min(colony$time)-years(1)), (max(colony$time)+years(1))),
       main = paste0(colonies$Location[colonies$geeID == i][1], ", ",
                     colonies$Country[colonies$geeID == i][1],
                     "; ID = ",ID))
  lines(x = p$time, y = p$precip/max(p$precip), col = 4)
  
  with(colony, points(time, ratio, type = "o"))
  mevi1 <- MEVI[MEVI$geeID == ID & MEVI$peak == 1,]
  mevi2 <- MEVI[MEVI$geeID == ID & MEVI$peak == 2,]
  # abline(v = ymd_hms(paste0(mevi1$date_EVI," 12:00:00")), col = "orange",
  #        lwd = (4*mevi1$amp)/max(c(mevi1$amp, mevi2$amp)))
  # abline(v = ymd_hms(paste0(mevi2$date_EVI," 12:00:00")), col = "brown",
  #        lwd = (4*mevi2$amp)/max(c(mevi1$amp, mevi2$amp)))
  # # abline(v = colonies$timestamp[colonies$geeID == ID], col = 2, lwd = 2)
  # legend("topright", legend = c("peak1", "peak2"), col = c("orange", "brown"), lty = 1)
  
  time <- as.Date(e$time)
  evi <- e$mean
  timep <- p$time
  
  # ttime <- as.Date(t$time)
  # te <- t$aet
  
  prp <- p$precip
  
  # dl <- geosphere::daylength(colony$Lat[1], seq(1,331, by = 30))
  # dayl <- data.frame(date = seq.Date(as.Date("2000-01-01"), 
  #                                    as.Date("2019-12-01"), 
  #                                    by = "month"), 
  #                    daylength = rep(dl, 20))
  # dayl$geeID <- ID
  # dayl$year <- year(dayl$date)
  # lines(dayl$date, rescale(dayl$daylength), 
  #       col = "gold", lwd = 2)
  
  spl <- smooth.spline(x = time, y = evi)
  # spl_t <- smooth.spline(x = ttime, y = te/max(te))
  spl_p <- smooth.spline(x = timep, y = prp) # spar = 0.2)
  # plot(spl_p, type = "l")
  pred <- predict(spl)
  # predt <- predict(spl_t)
  predp <- predict(spl_p)
  e$pred <- pred$y
  # t$pred <- predt$y
  p$pred <- predp$y
  lines(pred, col=2)
  # lines(predt, col = 4)
  lines(as.Date(p$time), p$pred/max(p$pred), col = "blue")
  
  ## get derivative of EVI -> IRG
  # pred.prime <- predict(spl, deriv=1)
  # pred.prime$y_scale <- rescale(pred.prime$y, c(0,1))
  # e$pred.prime <- pred.prime$y_scale
  
  # # get derivative of precipitation
  predp.prime <- predict(spl_p, deriv=1)
  # plot(predp.prime, type = "l")
  predp.prime$y_scale <- rescale(predp.prime$y, new.min = -1)
  # plot(predp.prime$y_scale, type = "l")
  p$pred.prime <- predp.prime$y_scale
  
  # plot first derivatives
  plot(as.Date(e$time), e$IRG/max(e$IRG), type = "l", ylab = "scaled IRG", col = 2,
       xlim = c((min(colony$time)-years(1)), (max(colony$time)+years(1))),
       ylim = c(-1, 1), xlab = "Date")
  lines(as.Date(p$time), p$pred.prime, col = 4)
  # lines(dayl$date, rescale(dayl$daylength), 
  #       col = "gold", lwd = 2)

  with(colony, points(time, ratio, type = "o"))
  # abline(v = ymd_hms(paste0(mevi1$date_IRG," 12:00:00")), col = "orange",
  #        lwd = (4*mevi1$amp)/max(c(mevi1$amp, mevi2$amp)))
  # abline(v = ymd_hms(paste0(mevi2$date_IRG," 12:00:00")), col = "brown",
  #        lwd = (4*mevi2$amp)/max(c(mevi1$amp, mevi2$amp)))
  # 
  ## add EVI, IRG, and Precip to reg colonies
  for(j in 1:length(c_idx)){
    colonies$evi[c_idx[j]] <- evi[which.min(abs(as.Date(colony$time[j]) - 
                                                      as.Date(time)))]
    colonies$irg[c_idx[j]] <- e$IRG[which.min(abs(as.Date(colony$time[j]) -
                                                                     as.Date(time)))]
    # colonies$grd[c_idx[j]] <- e$GRD[which.min(abs(as.Date(colony$time[j]) -
    #                                                                  as.Date(time)))]
    colonies$precip[c_idx[j]] <- p$precip[which.min(abs(as.Date(colony$time[j]) - 
                                                      as.Date(timep)))]
    colonies$precip_p[c_idx[j]] <- p$pred.prime[which.min(abs(as.Date(colony$time[j]) - 
                                                      as.Date(timep)))]
    # colonies$aet[c_idx[j]] <- t$aet[which.min(abs(as.Date(colony$time[j]) - as.Date(ttime)))]
  }
  
  # ggplot() +
  #   geom_line(data = e, aes(x = ymd_hms(startDate), y = pred.prime), col = 2) +
  #   geom_point(data = colony, aes(x = time, y = ratio)) + ylab("IRG") + xlab("Date")+
  #   geom_segment(data = colony, aes(x = time, xend = time, y = 0, yend = ratio)) +
  #   xlim(c(min(colony$time)-years(1), max(colony$time)+years(1))) + 
  #   theme_bw()
  
  years <- unique(year(e$time))
  e$year <- year(e$time)
  # to account for double peaks in a season, we will  pull out half year estimates
  e$halfyear <- year(e$time)+round(month(e$time)/12, 0)/2
  e_sum <- e %>% group_by(halfyear, year, geeID) %>% 
    summarise(EVI_spline = time[which.max(pred)],
              IRG_spline = time[which.max(IRG)],
              EOS_spline = time[which.min(IRG)],
              max_IRG = IRG[which.max(IRG)],
              min_IRG = IRG[which.min(IRG)],
              max_EVI = pred[which.max(pred)],
              min_EVI = pred[which.min(pred)],
              # area_EVI = trapz(as.numeric(time),pred),
              entropy = mean(entropy, na.rm = TRUE),
              seasonality = mean(seasonality, na.rm = TRUE))
  # t$year <- year(t$time)
  # t_sum <- t %>% group_by(year, geeID) %>% 
  #   summarise(aet_spline = time[which.max(pred)], 
  #             max_aet = aet[which.max(aet)],
  #             min_aet = aet[which.min(aet)])
  summary(p)
  p$year <- year(p$time)
  p$geeID <- ID
  p_sum <- p %>% group_by(year, geeID) %>% 
    summarise(precip_spline = time[which.max(precip)],
              precip_pspline = time[which.max(pred.prime)])

  MEVI$year <- year(MEVI$date_EVI)
  m_sum1 <- MEVI[MEVI$geeID == ID,] %>% group_by(geeID, year) %>% 
    summarise(EVI1_model = date_EVI[which(peak == 1)],
              EVI_model = date_EVI[which.max(amp)],
              IRG1_model = date_IRG[which(peak == 1)],
              IRG_model = date_IRG[which.max(amp)],
              amp = amp[which.max(amp)])
  
  m_sum2 <- MEVI[MEVI$geeID == ID,] %>% group_by(geeID, year) %>% 
    summarise(EVI2_model = date_EVI[which(peak == 2)],
              IRG2_model = date_IRG[which(peak == 2)])
  m_sum <- full_join(m_sum1, m_sum2)
  
  # dayl$daylength %>% plot(type = "l")
  # dl_sum <- dayl %>% group_by(geeID, year) %>%
  #   summarise(daylength_month = date[which.max(daylength)],
  #             daylength = daylength[which.max(daylength)])

  # plot(dayl$daylength)
  C <- full_join(e_sum, m_sum)
  # C <- full_join(C, t_sum)
  # C <- full_join(C, dl_sum)
  C <- full_join(C, p_sum)
  rs <- rbind(rs, C)
}
summary(rs)
save(colonies, rs, file = "../../../../Dropbox/MPI/Eidolon/Greenwave/rdata/regular_colonies_TRMM.Rdata")
load("../../../../Dropbox/MPI/Eidolon/Greenwave/rdata/regular_colonies_TRMM.Rdata")
# (rs$daylength) %>% plot
```  



# Check peak colony month
## find colony peaks
```{r}
Peaks <- data.frame()
IDs <- unique(colonies$geeID)
i = 14
for(i in 1:length(IDs)){
  rc <- colonies[colonies$geeID == IDs[i],]
  rc <- rc[order(rc$date),]
  # find peaks
  peak_time <- rc$date[findpeaks(rc$ratio)]
  
  # add any missed peaks at ratio of .6
  peak_time <- unique(c(peak_time, na.omit(rc$date[rc$ratio > 0.6])))
  
  peaks <- rc[which(rc$date %in% peak_time),]
  
  # plot peaks
  with(rc, plot(date, ratio, type = "o", pch = 16,
                col = as.numeric(is.na(Observer))+1,
                main = rc$Location[1]))
  abline(v = peaks$date, lty = 2) 
  
  # remove peaks with ratios below 0.4
  peaks <- peaks[which(peaks$ratio > 0.4),]
  
  
  # remove peaks that are within 6 months
  while(any(diff(peaks$date) < 180)){
    
    too_close <- which(diff(peaks$date) < 180)[1]
    
    # if sequential peaks with ratio = 1, then take the middle
    if(all(peaks$ratio[too_close:(too_close+1)] == 1)){
      idx <- which((peaks$date[too_close:(too_close+10)] - peaks$date[too_close]) < 180) 
      tmp <- rle(peaks$ratio[too_close:(too_close+(length(idx)-1))])
      ctmp <- rle(peaks$Count[too_close:(too_close+(length(idx)-1))])
      if(tmp$lengths[1] == ctmp$lengths[1]){
        # even
        if((tmp$lengths[1] %% 2) == 0){
          keep <- round(median(1:tmp$lengths[1]),0)
          kick <- (1:tmp$lengths[1])[-keep]
          peaks <- peaks[-(too_close+(kick-1)),]
        }
        # odd
        if((tmp$lengths[1] %% 2) != 0){
          keep <- median(1:tmp$lengths[1])
          kick <- (1:tmp$lengths[1])[-keep]
          peaks <- peaks[-(too_close+(kick-1)),]
        }
      }
        
    }
    # update too_close
    too_close <- which(diff(peaks$date) < 180)[1]
    
    # keep peak with higher ratio
    if(any(peaks$ratio[too_close:(too_close+1)] != 1))
    kick <- which.min(peaks$ratio[too_close:(too_close+1)])
    peaks <- peaks[-(too_close+kick-1),]
  }
  abline(v = peaks$date, lwd = 2, col = 4) 
  Peaks <- rbind(Peaks, peaks)
}
Peaks$month <- round_date(Peaks$date, unit = "month")

```

# strict peaks
```{r}
Strict_Peaks <- data.frame()
IDs <- 1:17
i = 14
for(i in 1:length(IDs)){
  rc <- colonies[colonies$geeID == IDs[i],]
  rc <- rc[order(rc$date),]
  # find peaks
  peak_time <- rc$date[findpeaks(rc$ratio)]
  
  # add any missed peaks at ratio of .6
  peak_time <- unique(c(peak_time, na.omit(rc$date[rc$ratio > 0.6])))
  
  peaks <- rc[which(rc$date %in% peak_time),]
  
  # plot peaks
  with(rc, plot(date, ratio, type = "o", pch = 16,
                col = as.numeric(is.na(Observer))+1,
                main = rc$Location[1]))
  abline(v = peaks$date, lty = 2) 
  
  # remove peaks with ratios below 0.6
  peaks <- peaks[which(peaks$ratio > 0.6),]
  
  
  # remove peaks that are within 10 months
  while(any(diff(peaks$date) < 300)){
    
    too_close <- which(diff(peaks$date) < 300)[1]
    
    # if sequential peaks with ratio = 1, then take the middle
    if(all(peaks$ratio[too_close:(too_close+1)] == 1)){
      idx <- which((peaks$date[too_close:(too_close+10)] - peaks$date[too_close]) < 180) 
      tmp <- rle(peaks$ratio[too_close:(too_close+(length(idx)-1))])
      ctmp <- rle(peaks$Count[too_close:(too_close+(length(idx)-1))])
      if(tmp$lengths[1] == ctmp$lengths[1]){
        # even
        if((tmp$lengths[1] %% 2) == 0){
          keep <- round(median(1:tmp$lengths[1]),0)
          kick <- (1:tmp$lengths[1])[-keep]
          peaks <- peaks[-(too_close+(kick-1)),]
        }
        # odd
        if((tmp$lengths[1] %% 2) != 0){
          keep <- median(1:tmp$lengths[1])
          kick <- (1:tmp$lengths[1])[-keep]
          peaks <- peaks[-(too_close+(kick-1)),]
        }
      }
        
    }
    # update too_close
    too_close <- which(diff(peaks$date) < 300)[1]
    
    # keep peak with higher ratio
    if(any(peaks$ratio[too_close:(too_close+1)] != 1))
    kick <- which.min(peaks$ratio[too_close:(too_close+1)])
    peaks <- peaks[-(too_close+kick-1),]
  }
  abline(v = peaks$date, lwd = 2, col = 4) 
  Strict_Peaks <- rbind(Strict_Peaks, peaks)
}
Strict_Peaks$month <- round_date(Strict_Peaks$date, unit = "month")

```

### summarize count concentration
```{r}
peak_circ <- Peaks %>% group_by(Country, Location) %>% 
  summarise(m = round(circ.mean.month(month(round_date(date, unit = "months"))),1),
            sd = round(as.numeric(mean.circular(x = sd.circular(month(round_date(date, unit = "months"))*360/12, type = "angles", units = "degrees", modulo = "2pi")))*12/(360),1),
    r = round(circ.intensity.month(month(round_date(date, unit = "months"))),1),
    HR = HR_test(data = circular(month(round_date(date, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[1],
    HR_p = HR_test(data = circular(month(round_date(date, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[2])
# peak_circ %>% write.csv
```

# plot colony and RS peaks 
```{r}
i = 14
rs_max <- rs %>% group_by(year, geeID) %>% 
  summarise(EVI_spline = EVI_spline[which.max(max_EVI)],
            IRG_spline = IRG_spline[which.max(max_IRG)],
            EVI_model = EVI_model[which.max(amp)],
            IRG_model = IRG_model[which.max(amp)],
            precip_spline = precip_spline[1],
            precip_pspline = precip_pspline[1],
            # aet_spline = aet_spline[which.max(max_aet)],
            entropy = entropy[1],
            max_EVI = max_EVI[which.max(max_EVI)]) # ,
            # daylength_month = rs$daylength_month[1])
i = 14
for(i in 1:length(IDs)){
  p <- Peaks[which(Peaks$geeID == IDs[i]),]
  r <- rs_max[which(rs_max$geeID == IDs[i]),]
  # layout(c(1,2))
  
  plot(r$year, month(r$IRG_spline), type = "o", pch = 16,
       ylab = "month", xlab = "", col = 2,
       ylim = c(0,12), main = paste(p$Location[1])) #, "spline"))
  # abline(v = 2000:2020, lty = 2)
  points(r$year, month(r$EVI_spline), type ="o", pch = 16, col = 3)
  points(r$year, month(r$precip_spline), type = "o", pch = 16, col = 4)
  points(r$year, month(r$precip_pspline), type = "o", pch = 16, col = "blue")
  # points(r$year, month(r$aet_spline), type = "o", pch = 16, col = 5)
  # points(r$year, month(r$daylength_month), type = "o", pch = 16, col = "gold")
  points(x = year(p$month), y = month(p$month), col = 1, pch = 16, cex = 2)
  
  
  legend("bottomleft", legend = c("EVI", "IRG", "Precip", "PrpStart", 
                                  "Colony"), pch = 16, col = c(3,2,4,"blue",
                                                               1))
  # plot(r$year, month(r$IRG_model), type = "o", pch = 16,
  #      ylab = "month", xlab = "", col = 3,
  #      ylim = c(0,12), main = paste(p$Location[1], "model"))
  # points(r$year, month(r$EVI_model), type ="o", pch = 16)
  # points(x = p$year, y = month(p$month), col = 2, pch = 16)
  # points(x = p$year, y = month(p$month), col = 2, pch = 16)
  
}
```
# summarize sd and mean date of phenology and peak count
```{r}
rs_max_sum <- rs_max %>% group_by(geeID) %>%
  summarise(EVI_month = round(circ.mean.month(month(round_date(EVI_spline, unit = "months"))),1),
            EVI_month_circ = round(as.numeric(mean.circular(x = circular(month(round_date(EVI_spline, unit = "months"))*360/12, 
                                                      type = "angles", units = "degrees", modulo = "2pi")))*12/(360),1),
            EVI_intensity = round(circ.intensity.month(month(round_date(EVI_spline, unit = "months"))),1),
            EVI_intensity_circ = round(circular::rho.circular(x = circular(month(round_date(EVI_spline, unit = "months"))*360/12, 
                                                      type = "angles", units = "degrees", modulo = "2pi")),1),
            EVI_HR = HR_test(data = circular(month(round_date(EVI_spline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[1],
            EVI_HR_p = HR_test(data = circular(month(round_date(EVI_spline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[2],
            IRG_month = round(circ.mean.month(month(round_date(IRG_spline, unit = "months"))),1),
            IRG_intensity = round(circ.intensity.month(month(round_date(IRG_spline, unit = "months"))),1),
            IRG_HR = HR_test(data = circular(month(round_date(IRG_spline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[1],
            IRG_HR_p = HR_test(data = circular(month(round_date(IRG_spline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[2],
            precip_month = round(circ.mean.month(month(round_date(precip_spline, unit = "months"))),1),
            precip_intensity = round(circ.intensity.month(month(round_date(precip_spline, unit = "months"))),1),
            precip_HR = HR_test(data = circular(month(round_date(precip_spline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[1],
            precip_HR_p = HR_test(data = circular(month(round_date(precip_spline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[2],
            precipp_month = round(circ.mean.month(month(round_date(precip_pspline, unit = "months"))),1),
            precipp_intensity = round(circ.intensity.month(month(round_date(precip_pspline, unit = "months"))),1),
            precipp_HR = HR_test(data = circular(month(round_date(precip_pspline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[1],
            precipp_HR_p = HR_test(data = circular(month(round_date(precip_pspline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))[2],
            entropy = entropy[which.max(entropy)])
rs_max_sum
# write.csv(rs_max_sum)

HR_test(data = circular(month(round_date(rs_max$EVI_spline, unit = "months"))*2*pi/12, 
                                                      type = "angles", units = "radians", modulo = "2pi"))

circular((1:5)*360/12, type = "angles", units = "degrees")
round(as.numeric(circular::mean.circular(x = circular((c(9:12))*360/12, type = "angles", units = "degrees", modulo = "2pi")))*12/(360),1)

rho.circular(x = circular((c(9:12))*360/12, type = "angles", units = "degrees", modulo = "2pi"))

round(circ.mean.month(9:12),1)
mean(9:12)
View(rs_max_sum)
round(rs_max_sum[,"EVI_HR"],1)

write.csv(rs_max_sum, file = "../../../../Dropbox/MPI/Eidolon/GreenWave/data/phen_summary.csv")
rs_max_sum <- read.csv("../../../../Dropbox/MPI/Eidolon/GreenWave/data/phen_summary.csv")
```

```{r}
rs_max_sum <- rs_max_sum[order(rs_max_sum$geeID),]
plot(rs_max_sum$geeID, rs_max_sum$EVI_intensity, type = "o", col = 3,
     ylab = "angular concentration", ylim = c(0,1))
points(rs_max_sum$geeID, rs_max_sum$IRG_intensity, type = "o", col = 2)
points(rs_max_sum$geeID, rs_max_sum$precip_intensity, type = "o", col = 4)
points(rs_max_sum$geeID, rs_max_sum$precipp_intensity, type = "o", col = "blue")
```

```{r}
rs_max_sum <- rs_max_sum[order(rs_max_sum$entropy),]
plot(rs_max_sum$entropy, rs_max_sum$EVI_intensity, type = "o", col = 3,
     ylab = "angular concentration")
points(rs_max_sum$entropy, rs_max_sum$IRG_intensity, type = "o", col = 2)
points(rs_max_sum$entropy, rs_max_sum$precip_intensity, type = "o", col = 4)
points(rs_max_sum$entropy, rs_max_sum$precipp_intensity, type = "o", col = "blue")
```

# Time to peak
## months
```{r}
IDs <- unique(Peaks$geeID)
Peaks$EVI_spline <- ymd("1900-01-01")
Peaks$IRG_spline <- ymd("1900-01-01")
Peaks$precip_spline <- ymd("1900-01-01")
Peaks$precip_pspline <- ymd("1900-01-01")
i = 1
for(i in 1:length(IDs)){
  pidx <- which(Peaks$geeID == IDs[i])
  p <- Peaks[pidx,]  
  r_half <- rs[rs$geeID == IDs[i],]
  r <- rs_max[rs_max$geeID == IDs[i],]
  j = 1
  for(j in 1:nrow(p)){
    # spline
    Peaks$EVI_spline[pidx[j]] <- round_date(
      ymd(r$EVI_spline[which.min(abs(p$month[j] - as.Date(r$EVI_spline)))]), 
      unit = "month")
    peak_EVI_diff <- abs(as.Date(Peaks$EVI_spline[pidx[j]]) - p$month[j])
    if(peak_EVI_diff > 182){
      Peaks$EVI_spline[pidx[j]] <- round_date(
        ymd(r_half$EVI_spline[which.min(abs(p$month[j] - as.Date(r_half$EVI_spline)))]), 
        unit = "month")
    }
    
    Peaks$IRG_spline[pidx[j]] <- round_date(
      ymd(r$IRG_spline[which.min(abs(p$month[j] - as.Date(r$IRG_spline)))]), 
      unit = "month")
    peak_IRG_diff <- abs(as.Date(Peaks$IRG_spline[pidx[j]]) - p$month[j])
    if(peak_IRG_diff > 182){
      Peaks$IRG_spline[pidx[j]] <- round_date(
        ymd(r_half$IRG_spline[which.min(abs(p$month[j] - as.Date(r_half$IRG_spline)))]), 
        unit = "month")
    }
    
    if(Peaks$IRG_spline[pidx[j]] == Peaks$EVI_spline[pidx[j]]){
       Peaks$EVI_spline[pidx[j]] <- round_date(
      ymd(r$EVI_spline[which.min(abs(p$month[j] - as.Date(r$EVI_spline)))]), 
      unit = "month")
    }    
    
   
    # precipitation
    Peaks$precip_spline[pidx[j]] <- round_date(
      r$precip_spline[which.min(abs(p$month[j] - as.Date(r$precip_spline)))], 
      unit = "month")
    
    Peaks$precip_pspline[pidx[j]] <- round_date(
      r$precip_pspline[which.min(abs(p$month[j] - as.Date(r$precip_pspline)))], 
      unit = "month")
   
  }
}

Peaks$months_to_EVI_spline <- round(difftime(Peaks$month,
                                             Peaks$EVI_spline,
                                             unit = "weeks")/4,0) %>% as.numeric
Peaks$months_to_IRG_spline <- round(difftime(Peaks$month,
                                             Peaks$IRG_spline, 
                                             unit = "weeks")/4,0) %>% as.numeric
Peaks$months_to_precip_spline <- round(difftime(Peaks$month, 
                                                Peaks$precip_spline, 
                                                unit = "weeks")/4,0) %>% as.numeric
Peaks$months_to_precip_pspline <- round(difftime(Peaks$month, 
                                                Peaks$precip_pspline, 
                                                unit = "weeks")/4,0) %>% as.numeric

wilcox.test(Peaks$months_to_EVI_spline, Peaks$months_to_IRG_spline)
wilcox.test(Peaks$months_to_precip_spline, Peaks$months_to_IRG_spline)
wilcox.test(Peaks$months_to_precip_pspline, Peaks$months_to_IRG_spline)
summary(Peaks)

sum(abs(Peaks$months_to_EVI_spline))
sum(abs(Peaks$months_to_IRG_spline))
sum(abs(Peaks$months_to_precip_spline))
sum(abs(Peaks$months_to_precip_pspline))

save(Peaks, Strict_Peaks, rs, file = "../../../../Dropbox/MPI/Eidolon/Greenwave/rdata/avg_peaks_TRMM.RData")
load("../../../../Dropbox/MPI/Eidolon/Greenwave/rdata/avg_peaks_TRMM.RData")
```

# rain onset
## daily
```{r}
dailyp <- read.csv("../../../../Dropbox/MPI/Eidolon/GreenWave/data/GEE/TRMM_3hr_DailyPrecip_EidolonColonies.csv")
dailyp$time <- dmy(dailyp$system.time_start)
rain_onset <- data.frame()
IDs = 1:17
for(i in 1:length(IDs)){
  p <- dailyp[dailyp$geeID == IDs[i],]
  tenp <- p %>% group_by(year = year(time), 
                            p10 = cut(time, "10 days")) %>% 
  summarise(p = sum(precipitation))
  twentyp <- p %>% group_by(year = year(time), 
                               p20 = cut(time, "20 days")) %>% 
  summarise(p = sum(precipitation))
  
  years <- unique(year(p$time))
  j = 1
  for(j in 1:length(years)){
    
    # 10 days with total of 25 mm total rainfall
    tp <- tenp[tenp$year == years[j],]
    tp_idx <- which(tp$p > 25)
    
    # then 20 day with > 20 mm total rainfall
    twp <- twentyp[twentyp$year == years[j],]  
    twp_idx <- which(twp$p > 20)
    
    plot(ymd(tp$p10), tp$p, type = "o")
    points(ymd(tp$p10[tp_idx]), tp$p[tp_idx], pch = 16)
    
    overlap <- which(tp$p10 %in% twp$p20[twp_idx])
    points(ymd(tp$p10[overlap]), tp$p[overlap], pch = 16, col = 2)
    
    onset <- NA
    ii <- 1
    try({
      while(is.na(onset)){
        if(any(tp_idx[ii]+1 == overlap)) onset <- ymd(tp$p10[tp_idx[ii]])
        ii <- ii + 1
      }
    })
  if(is.na(onset)){
    onset <- tp$p10[min(which(tp$p > 25))]
  }
  tmp <- data.frame(geeID = IDs[i], year = years[j], onset)
  rain_onset <- rbind(rain_onset, tmp)
  }
  plot(p$time, p$precipitation, type = "o", # col = (p$mm > 45)+1, 
       main = unique(reg_colonies$Location[reg_colonies$geeID == i]))
  abline(v = rain_onset$onset[rain_onset$geeID == i], col = 2, lwd = 2, lty = 2)
}

rain_onset_sum <- rain_onset %>% group_by(geeID, year) %>% 
  summarise(onset = onset[1],
    month = month(round_date(onset[1], unit = "month")))
rain_onset_sum %>% group_by(geeID) %>% 
  summarise(avg_month = round(circ.mean.month(na.omit(month)),1), 
            count = length(na.omit(month)))
```
### correlation with 
#### peak colony size
####PRP and IRP
```{r}
Peaks$rain_onset_daily <- as.Date("1900-01-01")

for(i in 1:nrow(Peaks)){
  idx <- which(rain_onset$geeID == Peaks$geeID[i] & 
               rain_onset$year == year(Peaks$date[i]))
  if(length(idx) > 0){
    Peaks$rain_onset_daily[i] <- rain_onset$onset[idx]  
  }
}
Peaks$rain_onset_daily[which(Peaks$rain_onset_daily < as.Date("1990-01-01"))] <- NA

round(cor.circular(y = pi*month(Peaks$month)/12, 
                   x = pi*month(Peaks$rain_onset_daily)/12), 2)
```


# plot each peak and env data around it
```{r}
i = 1
for(i in 1:nrow(Peaks)){
  p <- Peaks[i,]
  c <- colonies[colonies$geeID == p$geeID[1],]
  # EVI & IRG
  e <- EVI[EVI$geeID == p$geeID[1],]
  e$date <- as.Date(e$time)
  time <- as.Date(e$time)
  evi <- e$mean
  spl <- smooth.spline(x = time, y = evi)
  pred <- predict(spl)
  pred.prime <- predict(spl, deriv = 1)
  pred.prime$y01 <- rescale(pred.prime$y, new.min = -0.5, new.max = 0.5)
  
  # precip & precipp
  #prp <- precip[,(p$geeID[1]+1)]
  prp <- precip[precip$geeID == p$geeID[1],]
  # time <- as.Date(precip$time)
  time <- as.Date(prp$time)
  # spl <- smooth.spline(x = time, y = prp/max(prp))
  spl <- smooth.spline(x = time, y = prp$mean/max(prp$mean))
  predp <- predict(spl)
  predp.prime <- predict(spl, deriv = 1)
  predp.prime$y01 <- rescale(predp.prime$y, new.min = -0.5, new.max = 0.5)
  
  plot(p$month, p$ratio, 
       xlim = c(min(p$month) - years(2), 
                max(p$month) + years(2)), 
       ylim = c(-0.5, 1), 
       xlab = "time",
       ylab = "EVI/ratio", 
       main = p$Location[1])
         #paste0(p$Location[1], " LOS: ", p$LOS))
  abline(v = seq.Date(as.Date("2000-01-01"), 
                      as.Date("2021-01-01"), by = "year"), 
         col = "gray", lty = 2)
  abline(h = 0)
  lines(c$date, c$ratio, lty = 3, col = "gray")
  lines(e$date, e$mean, col = 3)
  # lines(pred, col = "darkgreen")
  lines(predp, col = 4)
  lines(pred.prime$x, pred.prime$y01, col = "darkred")
  lines(predp.prime$x, predp.prime$y01, col = "blue")
  # abline(v = p$LOS_start, col = 2, lty = 2, lwd = 2)
  abline(v = p$IRG_spline, col = 2)
  abline(v = p$EVI_spline, col = 3)
  abline(v = p$precip_spline, col = 4)
  abline(v = p$precip_pspline, col = "blue")
  # abline(v = p$LOS_end, col = "purple", lty = 2, lwd = 2)
  # abline(v = p$EOS_spline, col = "purple")
  # abline(v = p$aet_spline, col = "orange")
  
  # legend("topright", legend = c("Peak Colony Size", ))
}

```

# Fig 3
# Plot EVI, IRG and Precip vs Peak Colony 
```{r}
my.formula <- y ~ sin(pi*x/12)+cos(pi*x/12)

cbPalette <- c("#009E73", "#D55E00", "#56B4E9")

p1 <- 
  ggplot(Peaks, aes(y = month(month), 
                             x = month(EVI_spline)))+
                             #col = abs(Lat)))+
  geom_point(col = cbPalette[1])+xlim(c(0,12))+ylim(c(0,12))+
  # geom_smooth()+#, formula = my.formula)+
  geom_abline(slope = 1, intercept = 0)+
  ylab("Peak Colony Month")+xlab("Peak EVI Month")+
  # scale_color_viridis_c(name='abs(Latitude)', option='C', alpha=0.7)+
  theme_classic() +
  scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                                round(cor.circular(
                                  y = pi*month(Peaks$month)/12, 
                                  x = pi*month(Peaks$EVI_spline)/12), 2)))
  # stat_poly_eq(formula = my.formula, 
  #               aes(label = paste(..rr.label.., sep = "~~~")), 
  #               parse = TRUE)

p2 <- ggplot(Peaks, aes(y = month(month), 
                                 x = month(IRG_spline)))+
                                 #col = abs(Lat)))+
  geom_point(col = cbPalette[2])+
  #geom_smooth(method = "lm", formula = my.formula)+
  geom_abline(slope = 1, intercept = 0)+
  ylab("Peak Colony Month")+xlab("Peak IRG Month")+
  # scale_color_viridis_c(name='abs(Latitude)', option='C', alpha=0.7)+
  theme_classic()+
  scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                           round(cor.circular(
                             y = pi*month(Peaks$month)/12, 
                             x = pi*month(Peaks$IRG_spline)/12), 2)))
  # stat_poly_eq(formula = my.formula, 
  #               aes(label = paste(..rr.label.., sep = "~~~")), 
  #               parse = TRUE)
p3 <- 
  ggplot(Peaks, aes(y = month(month), 
                             x = month(precip_spline)))+
                             # col = abs(Lat)))+
  geom_point(col = cbPalette[3])+xlim(c(0,12))+ylim(c(0,12))+
  # geom_smooth(method = "lm", formula = my.formula)+
  geom_abline(slope = 1, intercept = 0)+
    ylab("Peak Colony Month")+xlab("Peak PRP Month")+
  # scale_color_viridis_c(name='abs(Latitude)', option='C', alpha=0.7)+
    theme_classic()+
    scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
    scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                           round(cor.circular(
                             y = pi*month(Peaks$month)/12, 
                             x = pi*month(Peaks$precip_spline)/12), 2)))
  # stat_poly_eq(formula = my.formula, 
  #               aes(label = paste(..rr.label.., sep = "~~~")), 
  #               parse = TRUE)

p4 <- 
  ggplot(Peaks, aes(y = month(month), 
                             x = month(precip_pspline)))+
                             # col = abs(Lat)))+
  geom_point(col = "turquoise")+xlim(c(0,12))+ylim(c(0,12))+
  # geom_smooth(method = "lm", formula = my.formula)+
  geom_abline(slope = 1, intercept = 0)+
    ylab("Peak Colony Month")+xlab("Peak IRP Month")+
  # scale_color_viridis_c(name='abs(Latitude)', option='C', alpha=0.7)+
    theme_classic()+
    scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
    scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                           round(cor.circular(
                             y = pi*month(Peaks$month)/12, 
                             x = pi*month(Peaks$precip_pspline)/12), 2)))

ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2, common.legend = TRUE)

```

## plot difference
```{r}
CC_mlt <- reshape2::melt(Peaks[,c("year", "Lat", "months_to_EVI_spline", "months_to_IRG_spline", "months_to_precip_spline", "months_to_precip_pspline")], id = c("year", "Lat"))

CC_mlt$variable <- plyr::revalue(CC_mlt$variable, c("months_to_EVI_spline"="Peak EVI", "months_to_IRG_spline"="Peak IRG", "months_to_precip_spline"="Peak PRP", "months_to_precip_pspline"="Peak IRP"))

# add statistical tests
my_comparisons <- list( c("Peak EVI", "Peak IRG"), 
                        c("Peak EVI", "Peak PRP"), 
                        c("Peak IRG", "Peak PRP"),
                        c("Peak IRG", "Peak IRP"), 
                        c("Peak PRP", "Peak IRP"), 
                        c("Peak EVI", "Peak IRP"))

p5 <- ggviolin(CC_mlt, x = "variable", y = "value", fill = "variable",
         palette = c(cbPalette, "turquoise"), 
         ylim = c(-10,25),
         add = "boxplot", add.params = list(fill = "white"))+
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))+ #, text = element_text(size = 20))+
  ylab("Months to Peak Colony Size")+ xlab("")+
  stat_compare_means(comparisons = my_comparisons, label = "p.signif")+ # Add significance levels
  stat_compare_means(label.y = 50)
p5

p <- ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2, common.legend = FALSE,
          labels = c("A", "B", "C", "D"), label.y = 1)  
p
f3 <- ggarrange(p+theme(text = element_text(size = 15)), 
                p5+theme_get()+
                  theme(legend.position = "none",
                        axis.text.x = element_text(angle = 30, vjust = 1, hjust=1),
                        text = element_text(size = 15)), 
                ncol = 2, heights = c(1,1), labels = c("", "E"), align = "v")

f3
ggsave(f3,
filename = "../../../../Dropbox/MPI/Eidolon/GreenWave/plots/fig3_TRMM.png", width = 11, height = 5)
```


# Strict Peaks Correlation
```{r}
p1 <- 
  ggplot(Peaks[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio),], 
         aes(y = month(month), 
                             x = month(EVI_spline)))+
  geom_point(col = cbPalette[1])+xlim(c(0,12))+ylim(c(0,12))+
  geom_abline(slope = 1, intercept = 0)+
  ylab("Peak Colony Month")+xlab("Peak EVI Month")+
  theme_classic() +
  scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                                round(cor.circular(
                                  y = pi*month(Peaks$month[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12, 
                                  x = pi*month(Peaks$EVI_spline[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12), 2)))
  
p2 <- ggplot(Peaks[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio),], 
             aes(y = month(month), 
                                 x = month(IRG_spline)))+
  geom_point(col = cbPalette[2])+xlim(c(0,12))+ylim(c(0,12))+
  geom_abline(slope = 1, intercept = 0)+
  ylab("Peak Colony Month")+xlab("Peak IRG Month")+
  theme_classic()+
  scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                           round(cor.circular(
                             y = pi*month(Peaks$month[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12, 
                             x = pi*month(Peaks$IRG_spline[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12), 2)))
  
p3 <- 
  ggplot(Peaks[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio),], 
         aes(y = month(month), 
                             x = month(precip_spline)))+
  geom_point(col = cbPalette[3])+xlim(c(0,12))+ylim(c(0,12))+
  geom_abline(slope = 1, intercept = 0)+
    ylab("Peak Colony Month")+xlab("Peak Precipitation Month")+
    theme_classic()+
    scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
    scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                           round(cor.circular(
                             y = pi*month(Peaks$month[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12, 
                             x = pi*month(Peaks$precip_spline[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12), 2)))
  
p4 <- 
  ggplot(Peaks[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio),], 
         aes(y = month(month), 
                             x = month(precip_pspline)))+
  geom_point(col = cbPalette[3])+xlim(c(0,12))+ylim(c(0,12))+
  geom_abline(slope = 1, intercept = 0)+
    ylab("Peak Colony Month")+xlab("Peak IRP Month")+
    theme_classic()+
    scale_y_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
    scale_x_continuous(breaks=c(3,6,9,12), limits = c(0,12))+
  geom_text(y = 10, x = 2, 
            label = paste0("cor: ", 
                           round(cor.circular(
                             y = pi*month(Peaks$month[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12, 
                             x = pi*month(Peaks$precip_pspline[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio)])/12), 2)))
  
ggarrange(p1,p2,p3,p4, ncol = 2, nrow = 2, common.legend = TRUE)
```

# model months to peak IRG
## prep data
```{r}
Peaks$log_colony_size <- log(Peaks$Count)
Peaks$abs_months_to_IRG_spline <- abs(Peaks$months_to_IRG_spline)
hist(Peaks$months_to_IRG_spline)
```
## join peaks and rs
```{r}
for(i in 1:nrow(Peaks)){
  idx <- which(Peaks$geeID[i] == rs$geeID & Peaks$year[i] == rs$year)
  Peaks$amp[i] <-     max(rs$amp[idx], na.rm = TRUE)
  Peaks$entropy[i] <- rs$entropy[idx]
  Peaks$max_EVI[i] <- max(rs$max_EVI[idx], na.rm = TRUE)
  Peaks$min_EVI[i] <- max(rs$min_EVI[idx], na.rm = TRUE)
  Peaks$max_IRG[i] <- max(rs$max_IRG[idx], na.rm = TRUE)
  Peaks$min_IRG[i] <- max(rs$min_IRG[idx], na.rm = TRUE)
}
Peaks$amp_EVI <- Peaks$max_EVI - Peaks$min_EVI
Peaks$log_colony_size <- log(Peaks$Count)

```

```{r}
save(Peaks, rs, file = "../../../../Dropbox/MPI/Eidolon/Greenwave/rdata/model_peaks_TRMM.RData")
load("../../../../Dropbox/MPI/Eidolon/Greenwave/rdata/model_peaks_TRMM.RData")
```

```{r}
Peaks$IRG_amp <- Peaks$max_IRG - Peaks$min_IRG
psych::pairs.panels(Peaks[,c("abs_months_to_IRG_spline", "log_colony_size",
                             "abs_Lat",
                             "ratio", "entropy", "max_EVI", "min_EVI", "max_IRG", "min_IRG", 
                             "IRG_amp",
                             "amp_EVI", "amp")])
summary(Peaks)
table(Peaks$Location)
```

### Fig S1
```{r}
p1 <- 
  ggplot(Peaks, aes(x = entropy, y = abs_months_to_IRG_spline))+
  geom_point(alpha = 0.2)+geom_smooth(method = "lm", col = "black")+
  theme_classic()+
  ylab("Months to Peak IRG")+xlab("Entropy")
p2 <- 
  ggplot(Peaks, #[-42,],
       aes(x = max_EVI, y = abs_months_to_IRG_spline))+
  geom_point(alpha = 0.2)+geom_smooth(method = "lm", col = "black")+
  theme_classic()+
  ylab("Months to Peak IRG")+xlab("max(EVI)")
p3 <- ggplot(Peaks, aes(x = log_colony_size, y = abs_months_to_IRG_spline))+
  geom_point(alpha = 0.2)+geom_smooth(method = "lm", col = "black")+
  theme_classic()+
  ylab("Months to Peak IRG")+xlab("log(colony size)")

ggarrange(p1,p2,p3, nrow = 1, labels = LETTERS[1:3])

Peaks$value <- "IRG"
p <- ggplot(Peaks,aes(y = abs_months_to_IRG_spline, x = value))+geom_violin(fill = cbPalette[2])+
  geom_jitter(alpha = 0.2, height = 0, width = 0.5)+
  #geom_hline(yintercept = 0)+
  theme_classic()+
  theme(text = element_text(size = 20))+
  xlab("")+ylab("abs(Months to Peak IRG)")
p
```

## bglmer
```{r}

(b0 <- blmer(abs(months_to_IRG_spline)~
             1+
             (1|geeID), Peaks,
control = lmerControl(check.conv.grad = "ignore"),
cov.prior = gamma))

(b1 <- blmer(abs(months_to_IRG_spline)~
             scale(max_EVI)+
             scale(entropy)+
             scale(log_colony_size)+
             (1|geeID), Peaks,
control = lmerControl(check.conv.grad = "ignore"),
cov.prior = gamma))
b1 %>% summary
b1 %>% confint()

(b2 <- blmer(abs(months_to_IRG_spline)~
             scale(max_EVI)+
               #scale(min_EVI)+
               # scale(IRG_amp)+
             scale(amp_EVI)+
               #scale(entropy)+
             scale(log_colony_size)+
             (1|geeID), Peaks,
control = lmerControl(check.conv.grad = "ignore"),
cov.prior = gamma))
summary(b2)
confint(b2)

BIC(b0, b1,b2)

tab_model(b1)
plot_model(b1, colors = "black")+theme_bw()

```

### Leave one out cross validation
```{r}
IDs <- 1:17
fits <- list()
r.sq <- list()

Peaks$predictIRG <- NA
i = 1

for(i in 1:length(IDs)){
  df <- Peaks[Peaks$geeID != IDs[i],]
  
  fits[[i]] <- blmer(abs(months_to_IRG_spline)~
             scale(max_EVI)+
             scale(entropy)+
             scale(log_colony_size)+
             (1|geeID), df,
  control = lmerControl(check.conv.grad = "ignore"),
  cov.prior = gamma)
  summary(fits[[i]])
  r.sq[[i]] <-  r.squaredGLMM(fits[[i]])
  
  df_out <- Peaks[Peaks$geeID == IDs[i],]
  Peaks$predictIRG[which(Peaks$geeID == IDs[i])] <- 
    predict(fits[[i]], df_out, allow.new.levels = TRUE)
}

my.formula <- y ~ x
fit <- lm(abs(months_to_IRG_spline)~ predictIRG, data = Peaks)
summary(fit)
ps2 <- ggplot(Peaks, aes(abs(months_to_IRG_spline), predictIRG, col = Location))+
  geom_point()+
  geom_smooth(method = "lm", col = 1)+
  theme_classic() #+
  # stat_poly_eq(formula = my.formula, 
  #               aes(label = paste(..rr.label.., sep = "~~~")), 
  #               parse = TRUE)

ggsave(ps2, filename = "../../../../Dropbox/MPI/Eidolon/Greenwave/plots/figs2.png")
r.sq_df <- sapply(r.sq, unlist)

locations <- unique(Peaks$Location) %>% as.factor()
par(mar = c(7,3,1,1))
plot(locations, r.sq_df[2,], ylab = "R^2", 
     xnt = TRUE,
     main = "", las = 2)
abline(h = mean(r.sq_df[2,]))
```


```{r}
sPeaks <- Peaks[which(Peaks$Date %in% Strict_Peaks$Date & Peaks$ratio %in% Strict_Peaks$ratio),]
```

## bglmer
```{r}

(b0 <- blmer(abs(months_to_IRG_spline)~
             1+
             (1|geeID), sPeaks,
control = lmerControl(check.conv.grad = "ignore"),
cov.prior = gamma))

(b1 <- blmer(abs(months_to_IRG_spline)~
             scale(max_EVI)+
             scale(entropy)+
             scale(log_colony_size)+
             (1|geeID), sPeaks,
control = lmerControl(check.conv.grad = "ignore"),
cov.prior = gamma))
b1 %>% summary
b1 %>% confint()

(b2 <- blmer(abs(months_to_IRG_spline)~
             scale(max_EVI)+
               #scale(min_EVI)+
               # scale(IRG_amp)+
             scale(amp_EVI)+
               #scale(entropy)+
             scale(log_colony_size)+
             (1|geeID), sPeaks,
control = lmerControl(check.conv.grad = "ignore"),
cov.prior = gamma))
summary(b2)
confint(b2)

BIC(b0, b1,b2)

tab_model(b1)
plot_model(b1, colors = "black")+theme_bw()

```

### Leave one out cross validation
```{r}
IDs <- 1:17
fits <- list()
r.sq <- list()

Peaks$predictIRG <- NA
i = 1

for(i in 1:length(IDs)){
  df <- sPeaks[sPeaks$geeID != IDs[i],]
  
  fits[[i]] <- blmer(abs(months_to_IRG_spline)~
             scale(max_EVI)+
             scale(entropy)+
             scale(log_colony_size)+
             (1|geeID), df,
  control = lmerControl(check.conv.grad = "ignore"),
  cov.prior = gamma)
  summary(fits[[i]])
  r.sq[[i]] <-  r.squaredGLMM(fits[[i]])
  
  df_out <- Peaks[Peaks$geeID == IDs[i],]
  Peaks$predictIRG[which(Peaks$geeID == IDs[i])] <- 
    predict(fits[[i]], df_out, allow.new.levels = TRUE)
}

my.formula <- y ~ x
fit <- lm(abs(months_to_IRG_spline)~ predictIRG, data = Peaks)
summary(fit)
ps2 <- ggplot(Peaks, aes(abs(months_to_IRG_spline), predictIRG, col = Location))+
  geom_point()+
  geom_smooth(method = "lm", col = 1)+
  theme_classic() #+
  # stat_poly_eq(formula = my.formula, 
  #               aes(label = paste(..rr.label.., sep = "~~~")), 
  #               parse = TRUE)

ggsave(ps2, filename = "../../../../Dropbox/MPI/Eidolon/Greenwave/plots/figs2_strict.png")
r.sq_df <- sapply(r.sq, unlist)


plot(r.sq_df[2,], ylab = "R^2", xlab = "Dropped Colony Index",
     main = "Leave one Colony Out Model Performance")
abline(h = mean(r.sq_df[2,]))
```